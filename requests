
/* 
1) Простой запрос с условием и формулами в SELECT (2)
•	Запрос показывает журналы, которые издаются уже 30 и более лет, и их основные показатели: импакт-фактор и h-индекс 
*/

	SELECT j.название, j.импакт_фактор , j.h_индекс , (2021 - 	j.год_начала_издания) AS 'Срок_издания'
	FROM кдз_213.dbo.журнал j
	Where (2021 - j.год_начала_издания) >= 30
	ORDER BY (2021 - j.год_начала_издания) DESC
  
/*
•	Запрос показывает журналы, у которых присутствует "скрытое" само цитирование, то есть долю цитирования журналами того же издательства
*/
	
	SELECT c.журнал, (c.Издания_Самоцитирования-	c.Самоцитирования) AS 	"Разница"
	FROM кдз_213.dbo.Самоцитирование c
	WHERE (c.Издания_Самоцитирования-c.Самоцитирования) != 0

/*
2) Запрос с коррелированным подзапросом в SELECT (2)
•	Запрос показывает, насколько коэффициент само цитирования журналов отличается от максимального
*/

	SELECT с.журнал, (SELECT MAX(с.Издания_Самоцитирования) 
	FROM кдз_213.dbo.Самоцитирование с) - 	с.Издания_Самоцитирования AS 	'разность'
	FROM кдз_213.dbo.Самоцитирование с

/*
•	Запрос показывает, сколько процентов составляет количество статьей, написанные определенным автором от всего количества статей
*/

	SELECT a.aid, a.Фамилия, a.Имя, a.Отчество, 	100*COUNT(sa.article_id)/
	(SELECT COUNT(sa.article_id) FROM кдз_213.dbo.статья_автор 	sa ) AS 	'процент' 
	FROM кдз_213.dbo.автор a join кдз_213.dbo.статья_автор sa 	on sa.aid = a.aid 
	join кдз_213.dbo.статья s on s.article_id = sa.article_id  	join кдз_213.dbo.выпуск i on 	i.issue_id = s.issue_id 
	GROUP BY a.aid, a.Фамилия, a.Имя, a.Отчество

/*
3) Запрос с подзапросом в FROM (2)
•	Запрос показывает название журнала и его индекс Хирша, если он входит в 20-ку журналов с наибольшим импакт-фактором
*/

	SELECT top20.jid, top20.название, top20.h_индекс  
	FROM (SELECT TOP 20 * FROM кдз_213.dbo.журнал j ORDER BY 	j.импакт_фактор ) as top20

/*
•	Запрос ранжирует журналы по индексу Хирша внутри каждого города и выделяет 5 с самым высоким индексом
*/

	SELECT *  FROM 
	(SELECT i.pid, i.название as 'Издательство', i.город, 	j.jid, 	j.название as 	'Журнал', j.h_индекс ,
	ROW_NUMBER ()over (partition by i.город order by j.h_индекс 	desc) 	as 	место_журнала
	FROM кдз_213.dbo.журнал j join кдз_213.dbo.издательство i 	on 	i.pid =j.pid ) as 	tb
	WHERE tb.место_журнала <= 5  AND tb.город  NOT LIKE ''

/*
4) Запрос с подзапросом в FROM, агрегированием, группировкой и сортировкой(2)
•	Запрос показывает разницу между  минимальным и максимальным количеством цитирований журналов в каждом году
*/

	SELECT tb.год_цитирования, MAX(tb.Цитирования) - 	MIN(tb.Цитирования) 	AS 'Разница'
	FROM (SELECT   j.название ,c.год_цитирования,  	SUM(c.количество) AS 	'Цитирования'
	FROM кдз_213.dbo.журнал j join кдз_213.dbo.цитирования c on 	c.jid_2 = j.jid 
	GROUP BY  c.год_цитирования, j.название   ) AS tb
	GROUP BY  tb.год_цитирования
	ORDER BY tb.год_цитирования

/*
•	Запрос показывает, сколько раз журнал, который хотя бы раз цитировали, процитировал сам другой журнал. Запрос отсортирован по убыванию, от самых цитируемых журналов,  к менее цитируемым
*/

	SELECT tb1.название, tb1.Цитировали_журнал, 	tb2.Цитировал_кого_то
	FROM (SELECT   j.название , 	SUM(c.количество) AS 	'Цитировали_журнал'
	FROM кдз_213.dbo.журнал j join кдз_213.dbo.цитирования c on 	c.jid_2 = j.jid 
	GROUP BY   j.название   ) AS tb1
	LEFT join (SELECT   j.название , 	SUM(c.количество) AS 	'Цитировал_кого_то'
	FROM кдз_213.dbo.журнал j join кдз_213.dbo.цитирования c on 	c.jid_1 = j.jid 
	GROUP BY   j.название   ) AS tb2
	on tb1.название = tb2.название
	ORDER BY tb1.Цитировали_журнал DESC

/*
5) Запрос с коррелированным подзапросом в WHERE (2)
•	Запрос отбирает авторов, у которых индекс Хирша выше среднего по всем авторам
*/

	SELECT a.Имя, a.Фамилия, a.Отчество FROM кдз_213.dbo.автор 	a 	
Where a.h_индекс > (SELECT AVG(a.h_индекс) FROM кдз_213.dbo.автор a  )

/*
•	Запрос отбирает журналы, у которых импакт - фактор меньше максимального импакт - фактора не более чем на 50%
*/

	SELECT j.jid, j.название, j.импакт_фактор FROM 	кдз_213.dbo.журнал j
	Where j.импакт_фактор >= 0.5*(SELECT MAX(j.импакт_фактор) 	FROM 	кдз_213.dbo.журнал j  )

/*
6) Запрос, использующий оконную функцию LAG или LEAD для выполнения сравнения данных в разных периодах  (1)
•	Запрос показывает динамику  изменений цитирований каждого журнала из года в год 
*/

	SELECT tb.название , tb.год_цитирования,tb.Цитирования, 
	(tb.Цитирования - (LAG (tb.Цитирования, 1,0) OVER 	(PARTITION BY 	tb.название ORDER BY tb.год_цитирования ))) 	AS 'Динамика'
	FROM (SELECT   j.название ,c.год_цитирования,  	SUM(c.количество) AS 	'Цитирования'
	FROM кдз_213.dbo.журнал j join кдз_213.dbo.цитирования c on 	c.jid_2 = j.jid 
	GROUP BY  c.год_цитирования, j.название   ) AS tb

/*
7) Запрос с агрегированием и выражением JOIN, включающим не менее 2 таблиц (3)
•	Запрос показывает коэффициент само цитирования не включая издательства
*/

	SELECT sc.jid_2, sc.Колво_самоцитирования, 	ct.Колво_цитирования, 	
	100*sc.Колво_самоцитирования/
	(sc.Колво_самоцитирования+ct.Колво_цитирования) AS 'Процент 	самоцитирования'
	FROM (SELECT c.jid_2 ,SUM(количество) as 	'Колво_самоцитирования' FROM 	кдз_213.dbo.цитирования c 
	WHERE c.jid_1 =c.jid_2 GROUP BY c.jid_2) AS sc JOIN 
	(SELECT c.jid_2 ,SUM(количество) as 'Колво_цитирования' FROM 	кдз_213.dbo.цитирования c 
	WHERE c.jid_1 !=c.jid_2 
	GROUP BY c.jid_2) AS ct on ct.jid_2 = sc.jid_2

/*
•	Запрос показывает средний h-индекс авторов, которые публикуют статьи на английском языке
*/

	SELECT AVG(a.h_индекс) AS 'Среднее значение'
	FROM кдз_213.dbo.автор a join  кдз_213.dbo.статья_автор sa 	on a.aid = sa.aid 
	join кдз_213.dbo.статья s on sa.article_id = s.article_id 	
	WHERE s.язык LIKE 'рус'

/*
•	Запрос показывает, сколько раз в среднем цитировался журнал за каждый код 
*/

	SELECT   j.название , c.год_цитирования,  AVG(c.количество)  AS 	'Цитирования'
	FROM кдз_213.dbo.журнал j join кдз_213.dbo.цитирования c on 	c.jid_2 = j.jid 
	GROUP BY c.год_цитирования, j.название

/*
8) Запрос с EXISTS (1)
•	Запрос показывает все статьи, которые имеют определенную тему и их авторов
*/

	SELECT s.article_id , a.aid, s.название, a.Фамилия, a.Имя, a.Отчество 
	FROM кдз_213.dbo.статья s join кдз_213.dbo.статья_автор sa 
	on s.article_id = sa.article_id 
	join кдз_213.dbo.автор a on a.aid = sa.aid
	WHERE EXISTS (SELECT s.название FROM кдз_213.dbo.тематика t 	WHERE 	s.tid = t.tid AND t.название = 'Экономика' )

/*
9) Запрос, использующий манипуляции с множествами (1)
•	Запрос позволяет узнать, включает ли какой-либо журнал в свои выпуски статьи на языках, которые не заявлены как основные для журнала
*/

  SELECT j.название, s.язык FROM кдз_213.dbo.статья s join 	кдз_213.dbo.выпуск i 	on i.issue_id = s.issue_id join кдз_213.dbo.журнал j on i.jid =j.jid 
	EXCEPT 
	SELECT j.название ,l.язык FROM кдз_213.dbo.журнал j  join 	кдз_213.dbo.язык_издания l on l.jid = j.jid 

/*
10) Запрос с внешним соединением и проверкой на наличие NULL (1)
•	Запрос показывает есть ли журнал, который ни разу не цитировали
*/

	SELECT j.название FROM кдз_213.dbo.журнал j LEFT JOIN 	
	(SELECT DISTINCT c.jid_2 FROM кдз_213.dbo.цитирования c) AS tb
	on tb.jid_2 = j.jid WHERE ISNULL(jid_2,1) = 1

/*
11) Запрос с агрегированием и выражением JOIN, включающим не менее 3 таблиц/выражений (1)
•	Запрос показывает каким журналам каждый автор отдает предпочтение для публикаций
*/

 	SELECT  a.Фамилия, a.Имя, a.Отчество, j.название 	AS'Журнал', 	COUNT(j.название) AS 'Количество'
	FROM кдз_213.dbo.автор a join  кдз_213.dbo.статья_автор sa 	on a.aid = sa.aid 
	join кдз_213.dbo.статья s on sa.article_id = s.article_id 	join кдз_213.dbo.выпуск i on 	i.issue_id = s.issue_id 
	join кдз_213.dbo.журнал j on j.jid = i.jid 
	GROUP BY a.Фамилия, a.Имя, a.Отчество, j.название

/*
12) Запрос с CASE (IIF) и агрегированием (1)
•	Запрос добавляет атрибут, оценивающий рост цитирований журнала за 4 года, если разница в количестве цитирований меньше нуля, считаем, что оно уменьшилось, если от 0 до 10, то не изменилось, так как рост в 10 статьей не является значительным, и если больше 10, то выросло.
*/

  SELECT tb1.название, tb1.разница,
	CASE 

	WHEN   разница> 10 THEN 'выросло'
	WHEN   разница < 0 THEN 'уменьшилось'
	WHEN   разница< 10 THEN 'не изменилось'

	END AS 'изменение'

	FROM
	(SELECT tb.название, tb.год_цитирования,
	tb.Количество - LAG (tb.Количество, 1,0) OVER 	(PARTITION BY 	tb.название ORDER BY tb.год_цитирования ) AS 'разница'
	FROM(
	SELECT j.название, c.год_цитирования, SUM(c.количество) AS 'Количество' 
	FROM кдз_213.dbo.цитирования c join кдз_213.dbo.журнал j on j.jid = c.jid_2
	WHERE c.год_цитирования = 2016 OR c.год_цитирования = 2020
	GROUP BY c.год_цитирования, j.название  ) AS tb) AS tb1
	WHERE tb1.год_цитирования = 2020

/*
13) Запрос с HAVING и агрегированием (1)
•	Запрос показывает авторов, которые уже выпустили хотя бы 1 статью в этом году
*/
  
  SELECT a.Фамилия, a.Имя, a.Отчество, COUNT(sa.article_id) 	AS 	'Количество статей'
	FROM кдз_213.dbo.автор a join  кдз_213.dbo.статья_автор sa 	on a.aid = sa.aid 
	join кдз_213.dbo.статья s on sa.article_id = s.article_id 	join кдз_213.dbo.выпуск i 
	on i.issue_id = s.issue_id 
	WHERE i.год = 2021
	GROUP BY  a.Фамилия, a.Имя, a.Отчество
	HAVING COUNT(sa.article_id) > 0
	
/*
14) Запрос SELECT INTO для подготовки выгрузки (1)
*/

  INSERT INTO OPENROWSET('Microsoft.Jet.OLEDB.4.0', 
  'Excel 8.0;Database=D:\testing.xls;', 
  'SELECT * FROM dbo.издательство') SELECT * FROM dbo.издательство
 


